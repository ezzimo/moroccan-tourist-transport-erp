# ------------------------------------------------
#  NGINX – Tourist ERP Front-end (React + APIs)
#  CORRECTED VERSION - Fixes Authentication Loop Issue
# ------------------------------------------------
server {
    listen 80;
    server_name _;

    # ----------------------------------------------------------
    # 1.  Static assets / client-side routes (React build)
    # ----------------------------------------------------------
    location / {
        root /usr/share/nginx/html;
        index index.html;
        try_files $uri $uri/ /index.html;
    }

    # ----------------------------------------------------------
    # 2.  Standard proxy headers for ALL API endpoints
    # ----------------------------------------------------------
    # These headers are applied to all location blocks below
    # CRITICAL: Authorization header forwarding for JWT tokens

    # -------------------------------------------------
    # 3.  Micro-service API entry points
    #     FIXED: Proper header forwarding and port mapping
    # -------------------------------------------------
    
    # Authentication Service - Port 8000 ✅
    location /api/v1/auth/ {
        proxy_pass http://auth_service:8000/api/v1/auth/;
        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization     $http_authorization;
    }

    location /api/v1/reports/ {
        proxy_pass http://qa_service:8009/api/v1/reports/;
        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization     $http_authorization;
    }

    # Fleet Service Endpoints - Port 8004 ✅
    location /api/v1/assignments/ {
        proxy_pass http://fleet_service:8004/api/v1/assignments/;
        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization     $http_authorization;
    }

    location /api/v1/documents/ {
        proxy_pass http://fleet_service:8004/api/v1/documents/;
        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization     $http_authorization;
    }

    location /api/v1/fuel/ {
        proxy_pass http://fleet_service:8004/api/v1/fuel/;
        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization     $http_authorization;
    }

    location /api/v1/maintenance/ {
        proxy_pass http://fleet_service:8004/api/v1/maintenance/;
        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization     $http_authorization;
    }

    location /api/v1/vehicles/ {
        proxy_pass http://fleet_service:8004/api/v1/vehicles/;
        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization     $http_authorization;
    }

    # CRM Service Endpoints - Port 8001 ✅
    location /api/v1/customers/ {
        proxy_pass http://crm_service:8001/api/v1/customers/;
        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization     $http_authorization;
    }

    location /api/v1/interactions/ {
        proxy_pass http://crm_service:8001/api/v1/interactions/;
        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization     $http_authorization;
    }

    location /api/v1/feedback/ {
        proxy_pass http://crm_service:8001/api/v1/feedback/;
        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization     $http_authorization;
    }

    location /api/v1/segments/ {
        proxy_pass http://crm_service:8001/api/v1/segments/;
        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization     $http_authorization;
    }

    # Booking Service - Port 8002 ✅
    location /api/v1/bookings/ {
        proxy_pass http://booking_service:8002/api/v1/bookings/;
        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization     $http_authorization;
    }

    # Driver Service - Port 8003 ✅
    location /api/v1/drivers/ {
        proxy_pass http://driver_service:8003/api/v1/drivers/;
        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization     $http_authorization;
    }

    # HR Service - Port 8005 ✅ FIXED: Was incorrectly pointing to 8006
    location /api/v1/hr/ {
        proxy_pass http://hr_service:8005/api/v1/hr/;
        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization     $http_authorization;
    }

    # Financial Service - Port 8006 ✅ FIXED: Was incorrectly pointing to 8005
    location /api/v1/financial/ {
        proxy_pass http://financial_service:8006/api/v1/financial/;
        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization     $http_authorization;
    }

    # Inventory Service - Port 8007 ✅
    location /api/v1/inventory/ {
        proxy_pass http://inventory_service:8008/api/v1/inventory/;
        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization     $http_authorization;
    }

    # Notification Service - Port 8008 ✅
    location /api/v1/notifications/ {
        proxy_pass http://notification_service:8007/api/v1/notifications/;
        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization     $http_authorization;
    }

    # QA Service - Port 8009 ✅
    location /api/v1/qa/ {
        proxy_pass http://qa_service:8009/api/v1/qa/;
        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization     $http_authorization;
    }

    # Tour Service - Port 8010 ✅
    location /api/v1/tour-templates/ {
        proxy_pass http://tour_service:8010/api/v1/tour-templates/;
        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization     $http_authorization;
    }

    location /api/v1/tour-instances/ {
        proxy_pass http://tour_service:8010/api/v1/tour-instances/;
        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization     $http_authorization;
    }

    location /api/v1/itinerary/ {
        proxy_pass http://tour_service:8010/api/v1/itinerary/;
        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization     $http_authorization;
    }

    location /api/v1/incidents/ {
        proxy_pass http://tour_service:8010/api/v1/incidents/;
        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization     $http_authorization;
    }

    # Analytics Dashboard (Financial Service) - Port 8006 ✅
    location /api/v1/analytics/ {
        proxy_pass http://financial_service:8006/api/v1/analytics/;
        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization     $http_authorization;
    }

    # -------------------------------------------------
    # 4. Catch-all for any other /api/v1/* endpoint
    #    (forward to auth_service until a gateway exists)
    # -------------------------------------------------
    location /api/v1/ {
        proxy_pass http://auth_service:8000/api/v1/;
        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization     $http_authorization;
    }

    # -------------------------------------------------
    # 5. Error handling and health checks
    # -------------------------------------------------
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }

    # Custom error pages
    error_page 502 503 504 /50x.html;
    location = /50x.html {
        root /usr/share/nginx/html;
    }
}


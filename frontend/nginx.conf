# NGINX – Tourist ERP Front-end (React + APIs)
server {
  listen 80;
  server_name _;

  # --- Dynamic DNS for Docker service names ---
  # Forces nginx to re-resolve names like "driver_service" each request.
  resolver 127.0.0.11 ipv6=off valid=10s;

  # --- Service bases (scheme + host:port, no path) ---
  set $svc_auth         http://auth_service:8000;
  set $svc_crm          http://crm_service:8001;
  set $svc_booking      http://booking_service:8002;
  set $svc_driver       http://driver_service:8003;
  set $svc_fleet        http://fleet_service:8004;
  set $svc_hr           http://hr_service:8005;
  set $svc_financial    http://financial_service:8006;
  set $svc_notification http://notification_service:8007;
  set $svc_inventory    http://inventory_service:8008;
  set $svc_qa           http://qa_service:8009;
  set $svc_tour         http://tour_service:8010;

  # --- Common proxy headers ---
  proxy_http_version 1.1;
  proxy_set_header Host              $host;
  proxy_set_header X-Real-IP         $remote_addr;
  proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header Authorization     $http_authorization;
  proxy_set_header Cookie            $http_cookie;
  proxy_read_timeout 60s;

  # --- CORS (server-wide) ---
  add_header Access-Control-Allow-Origin $http_origin always;
  add_header Access-Control-Allow-Credentials true always;
  add_header Access-Control-Allow-Headers Authorization,DNT,User-Agent,Keep-Alive,Content-Type,Accept,Origin,X-Requested-With,If-Modified-Since,Cache-Control,Range always;
  add_header Access-Control-Allow-Methods GET,POST,PUT,PATCH,DELETE,OPTIONS always;

  # Answer CORS preflight quickly
  if ($request_method = OPTIONS) { return 204; }

  # --- Static SPA + client routing ---
  root  /usr/share/nginx/html;
  index index.html;

  location / {
    try_files $uri $uri/ /index.html;
  }

  # ─────────────────────────────────────────────
  # Auth (highest priority)
  # ─────────────────────────────────────────────
  location ^~ /api/v1/auth/  { proxy_pass $svc_auth; }
  location ^~ /api/v1/users/ { proxy_pass $svc_auth; }
  location ^~ /api/v1/roles/ { proxy_pass $svc_auth; }

  # ─────────────────────────────────────────────
  # CRM (8001)
  # ─────────────────────────────────────────────
  location ^~ /api/v1/customers/    { proxy_pass $svc_crm; }
  location ^~ /api/v1/interactions/ { proxy_pass $svc_crm; }
  location ^~ /api/v1/feedback/     { proxy_pass $svc_crm; }
  location ^~ /api/v1/segments/     { proxy_pass $svc_crm; }

  # ─────────────────────────────────────────────
  # Booking (8002)
  # ─────────────────────────────────────────────
  location ^~ /api/v1/bookings/          { proxy_pass $svc_booking; }
  location ^~ /api/v1/availability/      { proxy_pass $svc_booking; }
  location ^~ /api/v1/pricing/           { proxy_pass $svc_booking; }
  location ^~ /api/v1/reservation-items/ { proxy_pass $svc_booking; }

  # ─────────────────────────────────────────────
  # Driver (8003)
  # ─────────────────────────────────────────────
  location ^~ /api/v1/drivers/ { proxy_pass $svc_driver; }

  # path rewrite: /driver-assignments/*  → /assignments/*
  location ^~ /api/v1/driver-assignments/ {
    rewrite ^/api/v1/driver-assignments/(.*)$ /api/v1/assignments/$1 break;
    proxy_pass $svc_driver;
  }

  location ^~ /api/v1/driver-training/  { proxy_pass $svc_driver; }
  location ^~ /api/v1/driver-incidents/ { proxy_pass $svc_driver; }
  location ^~ /api/v1/mobile/           { proxy_pass $svc_driver; }

  # ─────────────────────────────────────────────
  # Fleet (8004)
  # ─────────────────────────────────────────────
  location ^~ /api/v1/assignments/ { proxy_pass $svc_fleet; }
  location ^~ /api/v1/vehicles/    { proxy_pass $svc_fleet; }
  location ^~ /api/v1/maintenance/ { proxy_pass $svc_fleet; }
  location ^~ /api/v1/fuel/        { proxy_pass $svc_fleet; }

  # path rewrite: /fleet-documents/* → /documents/*
  location ^~ /api/v1/fleet-documents/ {
    rewrite ^/api/v1/fleet-documents/(.*)$ /api/v1/documents/$1 break;
    proxy_pass $svc_fleet;
  }

  # path rewrite: /fleet/* → /*
  location ^~ /api/v1/fleet/ {
    rewrite ^/api/v1/fleet/(.*)$ /api/v1/$1 break;
    proxy_pass $svc_fleet;
  }

  # ─────────────────────────────────────────────
  # Financial (8006)
  # ─────────────────────────────────────────────
  location ^~ /api/v1/invoices/  { proxy_pass $svc_financial; }
  location ^~ /api/v1/payments/  { proxy_pass $svc_financial; }
  location ^~ /api/v1/expenses/  { proxy_pass $svc_financial; }
  location ^~ /api/v1/analytics/ { proxy_pass $svc_financial; }

  # ─────────────────────────────────────────────
  # HR (8005)
  # ─────────────────────────────────────────────
  location ^~ /api/v1/employees/ { proxy_pass $svc_hr; }
  location ^~ /api/v1/schedules/ { proxy_pass $svc_hr; }
  location ^~ /api/v1/payroll/   { proxy_pass $svc_hr; }

  # ─────────────────────────────────────────────
  # Inventory (8008)
  # ─────────────────────────────────────────────
  location ^~ /api/v1/items/           { proxy_pass $svc_inventory; }
  location ^~ /api/v1/movements/       { proxy_pass $svc_inventory; }
  location ^~ /api/v1/suppliers/       { proxy_pass $svc_inventory; }
  location ^~ /api/v1/purchase-orders/ { proxy_pass $svc_inventory; }

  # path rewrite: /inventory/* → /*
  location ^~ /api/v1/inventory/ {
    rewrite ^/api/v1/inventory/(.*)$ /api/v1/$1 break;
    proxy_pass $svc_inventory;
  }

  # ─────────────────────────────────────────────
  # Notification (8007)
  # ─────────────────────────────────────────────
  location ^~ /api/v1/notifications/ { proxy_pass $svc_notification; }
  location ^~ /api/v1/templates/     { proxy_pass $svc_notification; }
  location ^~ /api/v1/preferences/   { proxy_pass $svc_notification; }
  location ^~ /api/v1/logs/          { proxy_pass $svc_notification; }

  # ─────────────────────────────────────────────
  # QA (8009)
  # ─────────────────────────────────────────────
  location ^~ /api/v1/reports/         { proxy_pass $svc_qa; }
  location ^~ /api/v1/audits/          { proxy_pass $svc_qa; }
  location ^~ /api/v1/nonconformities/ { proxy_pass $svc_qa; }
  location ^~ /api/v1/compliance/      { proxy_pass $svc_qa; }
  location ^~ /api/v1/certifications/  { proxy_pass $svc_qa; }

  # ─────────────────────────────────────────────
  # Tour (8010)
  # ─────────────────────────────────────────────
  location ^~ /api/v1/tour-templates/ { proxy_pass $svc_tour; }
  location ^~ /api/v1/tour-instances/ { proxy_pass $svc_tour; }
  location ^~ /api/v1/itinerary/      { proxy_pass $svc_tour; }
  location ^~ /api/v1/tours/          { proxy_pass $svc_tour; }
  location ^~ /api/v1/packages/       { proxy_pass $svc_tour; }
  location ^~ /api/v1/guides/         { proxy_pass $svc_tour; }
  location ^~ /api/v1/incidents/      { proxy_pass $svc_tour; }

  # Keep LAST: catch-all falls back to auth
  location ^~ /api/v1/ { proxy_pass $svc_auth; }
}
# End of nginx.conf
